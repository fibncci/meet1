{% extends 'base.html' %}

{% block title %}预订会议室 - 会议室预定系统{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">预订会议室</h4>
    </div>
    <div class="card-body">
        <form method="post" id="reserveForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="title" class="form-label">会议主题</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="room_id" class="form-label">选择会议室</label>
                        <select class="form-select" id="room_id" name="room_id" required>
                            <option value="">请选择会议室</option>
                            {% for room in rooms %}
                            <option value="{{ room.id }}" data-capacity="{{ room.capacity }}">
                                {{ room.name }} (容量: {{ room.capacity }}人)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date" class="form-label">日期</label>
                        <input type="date" class="form-control" id="date" name="date" min="{{ today.strftime('%Y-%m-%d') }}" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_time" class="form-label">开始时间</label>
                                <input type="time" class="form-control" id="start_time" name="start_time" min="08:00" max="19:30" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_time" class="form-label">结束时间</label>
                                <input type="time" class="form-control" id="end_time" name="end_time" min="08:30" max="20:00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="attendees" class="form-label">参会人数</label>
                        <input type="number" class="form-control" id="attendees" name="attendees" min="1" required>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="description" class="form-label">会议描述</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                    </div>
                    
                    <div class="card mt-4 mb-3" id="availabilityCard" style="display: none;">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">会议室可用性</h5>
                        </div>
                        <div class="card-body" id="availabilityInfo">
                            <p class="text-center text-muted">请选择会议室和日期查看可用性</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-primary">提交预订</button>
                <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">取消</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const roomIdParam = urlParams.get('room_id');
    
    // 如果URL中有room_id参数，自动选择对应的会议室
    if (roomIdParam) {
        document.getElementById('room_id').value = roomIdParam;
    }
    
    // 检查会议室容量
    document.getElementById('attendees').addEventListener('input', function() {
        const roomSelect = document.getElementById('room_id');
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        
        if (selectedOption.value) {
            const roomCapacity = parseInt(selectedOption.dataset.capacity);
            const attendees = parseInt(this.value);
            
            if (attendees > roomCapacity) {
                this.setCustomValidity(`参会人数超过会议室容量 (${roomCapacity}人)`);
            } else {
                this.setCustomValidity('');
            }
        }
    });
    
    // 检查时间有效性
    document.getElementById('end_time').addEventListener('input', function() {
        const startTime = document.getElementById('start_time').value;
        const endTime = this.value;
        
        if (startTime && endTime && startTime >= endTime) {
            this.setCustomValidity('结束时间必须晚于开始时间');
        } else {
            this.setCustomValidity('');
        }
    });
    
    // 检查会议室可用性
    function checkAvailability() {
        const roomId = document.getElementById('room_id').value;
        const date = document.getElementById('date').value;
        
        if (!roomId || !date) return;
        
        const availabilityCard = document.getElementById('availabilityCard');
        const availabilityInfo = document.getElementById('availabilityInfo');
        
        availabilityCard.style.display = 'block';
        availabilityInfo.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在检查可用性...</p></div>';
        
        fetch('/check_availability', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'room_id': roomId,
                'date': date
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.available) {
                availabilityInfo.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="bi bi-exclamation-triangle-fill"></i> ${data.message}
                    </div>
                `;
                return;
            }
            
            if (data.time_slots.length === 0) {
                availabilityInfo.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle-fill"></i> 该日期会议室全天可用
                    </div>
                `;
                return;
            }
            
            let html = '<h6>已预订时段:</h6><ul class="list-group">';
            
            data.time_slots.forEach(slot => {
                html += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${slot.start} - ${slot.end}</span>
                            <span class="badge bg-primary">${slot.title}</span>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            html += '<div class="alert alert-info mt-3 mb-0"><i class="bi bi-info-circle-fill"></i> 请避开上述已预订时段</div>';
            
            availabilityInfo.innerHTML = html;
        })
        .catch(error => {
            availabilityInfo.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> 检查可用性时出错
                </div>
            `;
            console.error('Error:', error);
        });
    }
    
    document.getElementById('room_id').addEventListener('change', checkAvailability);
    document.getElementById('date').addEventListener('change', checkAvailability);
    
    // 表单验证
    document.getElementById('reserveForm').addEventListener('submit', function(e) {
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;
        
        // 检查工作时间 (8:00-20:00)
        if (startTime < '08:00' || endTime > '20:00') {
            e.preventDefault();
            alert('预订时间必须在工作时间内（8:00-20:00）');
            return;
        }
        
        // 检查时间有效性
        if (startTime >= endTime) {
            e.preventDefault();
            alert('结束时间必须晚于开始时间');
            return;
        }
    });
    
    // 页面加载时如果已选择会议室，检查可用性
    window.addEventListener('load', function() {
        if (document.getElementById('room_id').value) {
            checkAvailability();
        }
    });
</script>
{% endblock %}
